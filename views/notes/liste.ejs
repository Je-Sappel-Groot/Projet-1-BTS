<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Evaluations</title>
  <link rel="stylesheet" href="/bootstrap/css/bootstrap.min.css">
  <link rel="stylesheet" href="/stylesheets/style.css">
</head>
<body>
  <%- include('../partials/navbar'); %>

  <div class="container my-5">
    <div class="d-flex flex-wrap justify-content-between align-items-center mb-3">
      <div>
        <h1 class="section-title mb-1">Evaluations</h1>
        <p class="section-subtitle mb-0">Notes et suivi de progression.</p>
      </div>
      <a href="/notes/ajouter" class="btn btn-accent">Ajouter une evaluation</a>
    </div>

    <div class="card lift-card p-3">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <span class="badge-soft">Liste</span>
        <input id="searchInput" type="text" placeholder="Rechercher..." class="form-control w-25" oninput="fetchNotes(1)">
      </div>

      <table class="table table-bordered table-hover">
        <thead>
          <tr>
            <th>Apprenant</th>
            <th>Formation</th>
            <th>Note</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="notesTable"></tbody>
      </table>

      <nav>
        <ul class="pagination justify-content-center" id="pagination"></ul>
      </nav>
    </div>
  </div>

  <script>
    let allNotes = [];
    let currentPage = 1;
    let totalPages = 1;

    async function fetchNotes(page = 1) {
      try {
        const searchTerm = document.getElementById('searchInput').value || '';
        const res = await fetch(`/api/notes?page=${page}&limit=5&search=${encodeURIComponent(searchTerm)}`);
        const data = await res.json();
        if (!res.ok) throw new Error(data.message || 'Erreur serveur');

        allNotes = data.notes || [];
        currentPage = data.pagination?.page || 1;
        totalPages = data.pagination?.totalPages || 1;

        renderTable();
        renderPagination();
      } catch (err) {
        document.getElementById('notesTable').innerHTML =
          `<tr><td colspan="4" class="text-center text-danger">Erreur API : ${err.message}</td></tr>`;
      }
    }

    function renderTable() {
      const tbody = document.getElementById('notesTable');
      tbody.innerHTML = '';

      if (!allNotes.length) {
        tbody.innerHTML = '<tr><td colspan="4" class="text-center">Aucune evaluation trouvee</td></tr>';
        return;
      }

      allNotes.forEach(note => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${note.etudiant?.nom || ''} ${note.etudiant?.prenom || ''}</td>
          <td>${note.cours?.nom || ''}</td>
          <td>${note.note}</td>
          <td>
            <a href="/notes/modifier/${note.id}" class="btn btn-outline-dark btn-sm">Modifier</a>
            <button class="btn btn-danger btn-sm" onclick="supprimerNote(${note.id})">Supprimer</button>
          </td>
        `;
        tbody.appendChild(row);
      });
    }

    function renderPagination() {
      const container = document.getElementById('pagination');
      container.innerHTML = '';

      for (let i = 1; i <= totalPages; i++) {
        const li = document.createElement('li');
        li.className = 'page-item' + (i === currentPage ? ' active' : '');
        li.innerHTML = `<button class="page-link" onclick="fetchNotes(${i})">${i}</button>`;
        container.appendChild(li);
      }
    }

    async function supprimerNote(id) {
      if (!confirm('Voulez-vous vraiment supprimer cette evaluation ?')) return;
      try {
        const res = await fetch(`/api/notes/${id}`, { method: 'DELETE' });
        if (!res.ok) {
          const data = await res.json();
          throw new Error(data.message || 'Erreur suppression');
        }
        fetchNotes(currentPage);
      } catch (err) {
        alert('Erreur : ' + err.message);
      }
    }

    fetchNotes();
  </script>

  <%- include('../partials/footer'); %>
  <script src="/bootstrap/js/bootstrap.bundle.min.js"></script>
</body>
</html>
