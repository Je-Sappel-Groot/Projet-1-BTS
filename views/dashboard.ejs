<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard</title>
  <link rel="stylesheet" href="/bootstrap/css/bootstrap.min.css">
  <link rel="stylesheet" href="/stylesheets/style.css">
</head>
<body>
  <%- include('partials/navbar'); %>

  <div class="container my-5">
    <div class="hero mb-4">
      <span class="badge-soft">Overview</span>
      <h1 class="mt-3">Dashboard medical</h1>
      <p class="section-subtitle">Vue rapide des activites, formations et evaluations.</p>
    </div>

    <div class="row g-4 mb-4">
      <div class="col-md-3">
        <div class="card lift-card p-3">
          <div class="d-flex align-items-center gap-3">
            <div class="icon-badge"><i class="bi bi-people"></i></div>
            <div>
              <div id="metric-etudiants" class="metric">0</div>
              <div class="text-muted">Apprenants</div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card lift-card p-3">
          <div class="d-flex align-items-center gap-3">
            <div class="icon-badge"><i class="bi bi-journal-medical"></i></div>
            <div>
              <div id="metric-cours" class="metric">0</div>
              <div class="text-muted">Formations</div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card lift-card p-3">
          <div class="d-flex align-items-center gap-3">
            <div class="icon-badge"><i class="bi bi-person-badge"></i></div>
            <div>
              <div id="metric-enseignants" class="metric">0</div>
              <div class="text-muted">Formateurs</div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card lift-card p-3">
          <div class="d-flex align-items-center gap-3">
            <div class="icon-badge"><i class="bi bi-clipboard-check"></i></div>
            <div>
              <div id="metric-moyenne" class="metric">0</div>
              <div class="text-muted">Moyenne</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="row g-4">
      <div class="col-lg-8">
        <div class="card lift-card p-4 h-100">
          <h5>Dernieres formations</h5>
          <p class="text-muted">Les 5 dernieres formations ajoutees.</p>
          <div id="formations-list" class="list-group list-group-flush">
            <div class="list-group-item">Chargement...</div>
          </div>
        </div>
      </div>
      <div class="col-lg-4">
        <div class="card lift-card p-4 h-100">
          <h5>Actions rapides</h5>
          <p class="text-muted">Acces aux sections principales.</p>
          <div class="d-grid gap-2">
            <a class="btn btn-accent" href="/etudiants">Apprenants</a>
            <a class="btn btn-outline-dark" href="/enseignants">Formateurs</a>
            <a class="btn btn-outline-dark" href="/cours">Formations</a>
            <a class="btn btn-outline-dark" href="/notes">Evaluations</a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <%- include('partials/footer'); %>
  <script src="/bootstrap/js/bootstrap.bundle.min.js"></script>
  <script>
    async function loadDashboard() {
      try {
        const res = await fetch('/api/dashboard');
        const data = await res.json();
        if (!res.ok) throw new Error(data.message || 'Erreur API');

        document.getElementById('metric-etudiants').textContent = data.counts.etudiants || 0;
        document.getElementById('metric-cours').textContent = data.counts.cours || 0;
        document.getElementById('metric-enseignants').textContent = data.counts.enseignants || 0;
        document.getElementById('metric-moyenne').textContent = data.moyenne || 0;

        const list = document.getElementById('formations-list');
        list.innerHTML = '';

        if (!data.dernieresFormations || !data.dernieresFormations.length) {
          list.innerHTML = '<div class="list-group-item">Aucune formation</div>';
          return;
        }

        data.dernieresFormations.forEach((formation) => {
          const enseignant = formation.enseignant ? `${formation.enseignant.nom} ${formation.enseignant.prenom}` : 'Non assigne';
          const item = document.createElement('div');
          item.className = 'list-group-item d-flex justify-content-between';
          item.innerHTML = `<span>${formation.nom}</span><span class="text-muted">${enseignant}</span>`;
          list.appendChild(item);
        });
      } catch (err) {
        const list = document.getElementById('formations-list');
        list.innerHTML = `<div class="list-group-item text-danger">${err.message}</div>`;
      }
    }

    loadDashboard();
  </script>
</body>
</html>
