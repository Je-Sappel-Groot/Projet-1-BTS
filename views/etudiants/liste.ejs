<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Liste des apprenants</title>
  <link rel="stylesheet" href="/bootstrap/css/bootstrap.min.css">
  <link rel="stylesheet" href="/stylesheets/style.css">
</head>
<body>
  <%- include('../partials/navbar'); %>

  <div class="container my-5">
    <div class="d-flex flex-wrap justify-content-between align-items-center mb-3">
      <div>
        <h1 class="section-title mb-1">Apprenants</h1>
        <p class="section-subtitle mb-0">Suivi des inscriptions et informations medicales.</p>
      </div>
      <a href="/etudiants/ajouter" class="btn btn-accent">Ajouter un apprenant</a>
    </div>

    <div class="card lift-card p-3">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <span class="badge-soft">Liste</span>
        <input id="searchInput" type="text" placeholder="Rechercher..." class="form-control w-25" oninput="fetchEtudiants(1)">
      </div>

      <table class="table table-bordered table-hover">
        <thead>
          <tr>
            <th>Nom</th>
            <th>Prenom</th>
            <th>Adresse</th>
            <th>Date de naissance</th>
            <th>Telephone</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="etudiantsTable"></tbody>
      </table>

      <nav>
        <ul class="pagination justify-content-center" id="pagination"></ul>
      </nav>
    </div>
  </div>

  <script>
    let allEtudiants = [];
    let currentPage = 1;
    let totalPages = 1;

    async function fetchEtudiants(page = 1) {
      try {
        const searchTerm = document.getElementById('searchInput').value || '';
        const response = await fetch(`/api/etudiants?page=${page}&limit=5&search=${encodeURIComponent(searchTerm)}`);
        const result = await response.json();

        if (!response.ok) throw new Error(result.message || 'Erreur serveur.');

        allEtudiants = result.etudiants || [];
        totalPages = result.pagination?.totalPages || 1;
        currentPage = result.pagination?.page || 1;

        renderTable();
        renderPagination();
      } catch (error) {
        const tbody = document.getElementById('etudiantsTable');
        tbody.innerHTML = `<tr><td colspan="6" class="text-center text-danger">Erreur API : ${error.message}</td></tr>`;
      }
    }

    function renderTable() {
      const tbody = document.getElementById('etudiantsTable');
      tbody.innerHTML = '';

      if (!allEtudiants.length) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center">Aucun apprenant trouve</td></tr>';
        return;
      }

      allEtudiants.forEach(etudiant => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${etudiant.nom}</td>
          <td>${etudiant.prenom}</td>
          <td>${etudiant.adresse}</td>
          <td>${etudiant.dob || ''}</td>
          <td>${etudiant.phone || ''}</td>
          <td>
            <a href="/etudiants/modifier/${etudiant.id}" class="btn btn-outline-dark btn-sm">Modifier</a>
            <button class="btn btn-danger btn-sm" onclick="supprimerEtudiant(${etudiant.id})">Supprimer</button>
          </td>
        `;
        tbody.appendChild(row);
      });
    }

    function renderPagination() {
      const container = document.getElementById('pagination');
      container.innerHTML = '';

      for (let i = 1; i <= totalPages; i++) {
        const li = document.createElement('li');
        li.className = 'page-item' + (i === currentPage ? ' active' : '');
        li.innerHTML = `<button class="page-link" onclick="fetchEtudiants(${i})">${i}</button>`;
        container.appendChild(li);
      }
    }

    async function supprimerEtudiant(id) {
      if (!confirm('Voulez-vous vraiment supprimer cet apprenant ?')) return;
      try {
        const response = await fetch(`/api/etudiants/${id}`, { method: 'DELETE' });
        if (!response.ok) {
          const data = await response.json();
          throw new Error(data.message || 'Erreur suppression');
        }
        fetchEtudiants(currentPage);
      } catch (err) {
        alert('Erreur : ' + err.message);
      }
    }

    fetchEtudiants();
  </script>

  <%- include('../partials/footer'); %>
  <script src="/bootstrap/js/bootstrap.bundle.min.js"></script>
</body>
</html>
